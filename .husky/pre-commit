#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üîé Running TypeScript type check..."

# Get staged TS/TSX files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E "\.(ts|tsx)$")

if [ -n "$STAGED_FILES" ]; then
  # Check TypeScript types using our strict configuration
  node scripts/type-check.mjs --strict
  
  # Store the exit code
  TYPE_CHECK_EXIT_CODE=$?
  
  # If type checking failed, abort the commit
  if [ $TYPE_CHECK_EXIT_CODE -ne 0 ]; then
    echo "‚ùå TypeScript type check failed. Please fix the errors before committing."
    exit 1
  fi
  
  # Run ESLint on staged files
  echo "üîç Running ESLint on staged TypeScript files..."
  npx eslint $STAGED_FILES --fix
  
  # Re-stage files that might have been fixed by ESLint
  for FILE in $STAGED_FILES; do
    if [ -f "$FILE" ]; then
      git add "$FILE"
    fi
  done
fi

echo "‚úÖ TypeScript checks passed!"
exit 0